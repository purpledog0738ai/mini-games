<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stack - Mini Games</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Ìó§Îçî */
        .header {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            z-index: 100;
        }
        .score-box, .best-box {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .score-box .label, .best-box .label {
            font-size: 0.7rem;
            opacity: 0.7;
            text-transform: uppercase;
        }
        .score-box .value, .best-box .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Ï∫îÎ≤ÑÏä§ */
        canvas {
            width: 100%;
            height: 100%;
        }

        /* ÌçºÌéôÌä∏ ÌëúÏãú */
        .perfect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: perfectAnim 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 200;
        }
        @keyframes perfectAnim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-50px); }
        }

        /* ÏΩ§Î≥¥ ÌëúÏãú */
        .combo {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            animation: comboAnim 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 200;
        }
        @keyframes comboAnim {
            0% { opacity: 0; transform: translateX(-50%) scale(0.8); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.1); }
            100% { opacity: 0; transform: translateX(-50%) scale(1); }
        }

        /* Î©îÎâ¥ ÌôîÎ©¥ */
        .menu-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 300;
        }
        .menu-screen.hidden { display: none; }

        .menu-screen h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .menu-screen .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        .menu-screen .desc {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .stat-item .label {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .stat-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }

        .btn {
            background: linear-gradient(145deg, #00ff88, #00d4ff);
            color: #1a1a2e;
            border: none;
            padding: 18px 50px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,255,136,0.3);
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: scale(0.98); }

        /* Í≤åÏûÑÏò§Î≤Ñ Ïò§Î≤ÑÎ†àÏù¥ */
        .gameover-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 400;
        }
        .gameover-overlay.hidden { display: none; }

        .gameover-overlay h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .gameover-overlay .final-score {
            font-size: 5rem;
            font-weight: bold;
            color: #00ff88;
            margin: 20px 0;
            text-shadow: 0 0 30px rgba(0,255,136,0.5);
        }
        .gameover-overlay .final-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        .gameover-overlay .stat {
            text-align: center;
        }
        .gameover-overlay .stat .num {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
        }
        .gameover-overlay .stat .txt {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .new-record {
            color: #FFD700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ÌûåÌä∏ */
        .hint {
            position: fixed;
            bottom: 50px;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
            z-index: 50;
        }

        /* Î∏îÎ°ù ÎØ∏Î¶¨Î≥¥Í∏∞ (3D Ìö®Í≥º) */
        .block-preview {
            display: flex;
            gap: 5px;
            margin: 30px 0;
        }
        .preview-block {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            animation: float 2s ease-in-out infinite;
        }
        .preview-block:nth-child(1) { background: #e74c3c; animation-delay: 0s; }
        .preview-block:nth-child(2) { background: #f39c12; animation-delay: 0.2s; }
        .preview-block:nth-child(3) { background: #2ecc71; animation-delay: 0.4s; }
        .preview-block:nth-child(4) { background: #3498db; animation-delay: 0.6s; }
        .preview-block:nth-child(5) { background: #9b59b6; animation-delay: 0.8s; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- Î©îÎâ¥ ÌôîÎ©¥ -->
    <div class="menu-screen" id="menuScreen">
        <div class="icon">üì¶</div>
        <h1>Stack</h1>
        <p class="desc">Î∏îÎ°ùÏùÑ ÏåìÏïÑ Ïò¨Î†§Îùº!</p>

        <div class="block-preview">
            <div class="preview-block"></div>
            <div class="preview-block"></div>
            <div class="preview-block"></div>
            <div class="preview-block"></div>
            <div class="preview-block"></div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="label">ÏµúÍ≥† Í∏∞Î°ù</div>
                <div class="value" id="bestScore">0</div>
            </div>
            <div class="stat-item">
                <div class="label">Ï¥ù ÌîåÎ†àÏù¥</div>
                <div class="value" id="totalPlays">0</div>
            </div>
        </div>

        <button class="btn" id="startBtn">üéÆ ÏãúÏûëÌïòÍ∏∞</button>
    </div>

    <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
    <div class="game-container">
        <div class="header">
            <div class="score-box">
                <div class="label">Ï†êÏàò</div>
                <div class="value" id="score">0</div>
            </div>
            <div class="best-box">
                <div class="label">ÏµúÍ≥†</div>
                <div class="value" id="currentBest">0</div>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- Í≤åÏûÑÏò§Î≤Ñ Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="gameover-overlay hidden" id="gameoverOverlay">
        <h2>üòµ Í≤åÏûÑ Ïò§Î≤Ñ!</h2>
        <div class="new-record hidden" id="newRecord">üèÜ Ïã†Í∏∞Î°ù!</div>
        <div class="final-score" id="finalScore">0</div>
        <div class="final-stats">
            <div class="stat">
                <div class="num" id="finalPerfects">0</div>
                <div class="txt">ÌçºÌéôÌä∏</div>
            </div>
            <div class="stat">
                <div class="num" id="finalMaxCombo">0</div>
                <div class="txt">ÏµúÎåÄ ÏΩ§Î≥¥</div>
            </div>
        </div>
        <button class="btn" id="restartBtn">üîÑ Îã§Ïãú ÌïòÍ∏∞</button>
        <button class="btn" id="menuBtn" style="background: transparent; border: 2px solid white; color: white; margin-top: 10px;">üè† Î©îÎâ¥Î°ú</button>
    </div>

    <p class="hint" id="hint">ÌÑ∞ÏπòÌïòÏó¨ Î∏îÎ°ùÏùÑ ÎÜìÏúºÏÑ∏Ïöî!</p>

    <!-- ÏÇ¨Ïö¥Îìú -->
    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function playSound(type) {
            if (!audioCtx) audioCtx = new AudioContext();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'place') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'perfect') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(900, audioCtx.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'combo') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.15);
                gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.15);
            } else if (type === 'gameover') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.4);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.4);
            }
        }
    </script>

    <script>
        // DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menuScreen');
        const gameoverOverlay = document.getElementById('gameoverOverlay');
        const scoreEl = document.getElementById('score');
        const currentBestEl = document.getElementById('currentBest');
        const bestScoreEl = document.getElementById('bestScore');
        const totalPlaysEl = document.getElementById('totalPlays');
        const finalScoreEl = document.getElementById('finalScore');
        const finalPerfectsEl = document.getElementById('finalPerfects');
        const finalMaxComboEl = document.getElementById('finalMaxCombo');
        const newRecordEl = document.getElementById('newRecord');
        const hint = document.getElementById('hint');

        // Í≤åÏûÑ ÏÉÅÌÉú
        let isPlaying = false;
        let score = 0;
        let perfects = 0;
        let combo = 0;
        let maxCombo = 0;
        let speed = 3;

        // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞
        let bestScore = parseInt(localStorage.getItem('stackBest')) || 0;
        let totalPlays = parseInt(localStorage.getItem('stackPlays')) || 0;
        bestScoreEl.textContent = bestScore;
        currentBestEl.textContent = bestScore;
        totalPlaysEl.textContent = totalPlays;

        // Î∏îÎ°ù Ïä§ÌÉù
        let blocks = [];
        let currentBlock = null;
        let fallingBlocks = [];

        // ÏÉâÏÉÅ ÌåîÎ†àÌä∏
        const colors = [
            '#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#1abc9c',
            '#3498db', '#9b59b6', '#e91e63', '#00bcd4', '#ff5722'
        ];

        // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ÏÉâÏÉÅ ÏÑ†ÌÉù
        function getColor(index) {
            return colors[index % colors.length];
        }

        // Î∏îÎ°ù ÏÉùÏÑ±
        function createBlock(x, width, y) {
            return {
                x: x,
                y: y,
                width: width,
                height: 30,
                color: getColor(blocks.length),
                direction: 1,
                speed: speed
            };
        }

        // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
        function initGame() {
            blocks = [];
            fallingBlocks = [];
            score = 0;
            perfects = 0;
            combo = 0;
            maxCombo = 0;
            speed = 3;

            scoreEl.textContent = '0';

            // Ï≤´ Î≤àÏß∏ Î∏îÎ°ù (Í≥†Ï†ï)
            const startWidth = 150;
            const startX = (canvas.width - startWidth) / 2;
            blocks.push({
                x: startX,
                y: canvas.height - 100,
                width: startWidth,
                height: 30,
                color: getColor(0)
            });

            // ÏõÄÏßÅÏù¥Îäî Î∏îÎ°ù ÏÉùÏÑ±
            spawnNewBlock();
        }

        // ÏÉà Î∏îÎ°ù ÏÉùÏÑ±
        function spawnNewBlock() {
            const lastBlock = blocks[blocks.length - 1];
            currentBlock = {
                x: 0,
                y: lastBlock.y - 35,
                width: lastBlock.width,
                height: 30,
                color: getColor(blocks.length),
                direction: 1,
                speed: speed
            };
        }

        // Î∏îÎ°ù Î∞∞Ïπò
        function placeBlock() {
            if (!currentBlock || !isPlaying) return;

            const lastBlock = blocks[blocks.length - 1];
            
            // Í≤πÏπòÎäî Î∂ÄÎ∂Ñ Í≥ÑÏÇ∞
            const overlapLeft = Math.max(currentBlock.x, lastBlock.x);
            const overlapRight = Math.min(currentBlock.x + currentBlock.width, lastBlock.x + lastBlock.width);
            const overlapWidth = overlapRight - overlapLeft;

            if (overlapWidth <= 0) {
                // ÏôÑÏ†ÑÌûà Î≤óÏñ¥ÎÇ® - Í≤åÏûÑ Ïò§Î≤Ñ
                fallingBlocks.push({...currentBlock, vy: 0});
                currentBlock = null;
                playSound('gameover');
                endGame();
                return;
            }

            // ÌçºÌéôÌä∏ Ï≤¥ÌÅ¨ (ÌóàÏö© Ïò§Ï∞® 5px)
            const isPerfect = Math.abs(currentBlock.x - lastBlock.x) <= 5;
            
            if (isPerfect) {
                // ÌçºÌéôÌä∏!
                perfects++;
                combo++;
                if (combo > maxCombo) maxCombo = combo;
                
                // ÌçºÌéôÌä∏Î©¥ Ïù¥Ï†Ñ Î∏îÎ°ù ÎÑàÎπÑ Ïú†ÏßÄ
                blocks.push({
                    x: lastBlock.x,
                    y: currentBlock.y,
                    width: lastBlock.width,
                    height: 30,
                    color: currentBlock.color
                });
                
                showPerfect();
                if (combo >= 2) {
                    showCombo(combo);
                    playSound('combo');
                } else {
                    playSound('perfect');
                }
            } else {
                // ÏùºÎ∞ò Î∞∞Ïπò
                combo = 0;
                
                // ÏûòÎ¶∞ Î∂ÄÎ∂Ñ Îñ®Ïñ¥Îú®Î¶¨Í∏∞
                if (currentBlock.x < lastBlock.x) {
                    // ÏôºÏ™ΩÏù¥ ÏûòÎ¶º
                    fallingBlocks.push({
                        x: currentBlock.x,
                        y: currentBlock.y,
                        width: lastBlock.x - currentBlock.x,
                        height: 30,
                        color: currentBlock.color,
                        vy: 0
                    });
                } else if (currentBlock.x + currentBlock.width > lastBlock.x + lastBlock.width) {
                    // Ïò§Î•∏Ï™ΩÏù¥ ÏûòÎ¶º
                    fallingBlocks.push({
                        x: lastBlock.x + lastBlock.width,
                        y: currentBlock.y,
                        width: (currentBlock.x + currentBlock.width) - (lastBlock.x + lastBlock.width),
                        height: 30,
                        color: currentBlock.color,
                        vy: 0
                    });
                }
                
                // ÎÇ®ÏùÄ Î∏îÎ°ù Ï∂îÍ∞Ä
                blocks.push({
                    x: overlapLeft,
                    y: currentBlock.y,
                    width: overlapWidth,
                    height: 30,
                    color: currentBlock.color
                });
                
                playSound('place');
            }

            score++;
            scoreEl.textContent = score;
            
            // ÏÜçÎèÑ Ï¶ùÍ∞Ä
            if (score % 5 === 0) {
                speed = Math.min(speed + 0.5, 12);
            }

            // ÌôîÎ©¥ Ïä§ÌÅ¨Î°§ (Î∏îÎ°ùÏù¥ Ïò¨ÎùºÍ∞ê)
            if (currentBlock.y < canvas.height * 0.6) {
                const shift = 35;
                blocks.forEach(b => b.y += shift);
                fallingBlocks.forEach(b => b.y += shift);
            }

            // Îã§Ïùå Î∏îÎ°ù
            spawnNewBlock();
        }

        // ÌçºÌéôÌä∏ ÌëúÏãú
        function showPerfect() {
            const el = document.createElement('div');
            el.className = 'perfect';
            el.textContent = '‚ú® PERFECT! ‚ú®';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // ÏΩ§Î≥¥ ÌëúÏãú
        function showCombo(n) {
            const el = document.createElement('div');
            el.className = 'combo';
            el.textContent = `üî• ${n} COMBO!`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        // Í≤åÏûÑ Î£®ÌîÑ
        function gameLoop() {
            if (!isPlaying) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Î∞∞Í≤Ω Í∑∏ÎùºÎç∞Ïù¥ÏÖò (ÎèôÏ†Å)
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            const hue = (score * 5) % 360;
            gradient.addColorStop(0, `hsl(${hue}, 30%, 15%)`);
            gradient.addColorStop(1, `hsl(${(hue + 60) % 360}, 40%, 20%)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ÏåìÏù∏ Î∏îÎ°ù Í∑∏Î¶¨Í∏∞
            blocks.forEach((block, i) => {
                drawBlock(block, i);
            });

            // Îñ®Ïñ¥ÏßÄÎäî Î∏îÎ°ù
            fallingBlocks = fallingBlocks.filter(block => {
                block.vy += 0.5;
                block.y += block.vy;
                drawBlock(block);
                return block.y < canvas.height + 50;
            });

            // ÌòÑÏû¨ Î∏îÎ°ù ÏõÄÏßÅÏûÑ
            if (currentBlock) {
                currentBlock.x += currentBlock.direction * currentBlock.speed;
                
                // Î≤Ω Ï∂©Îèå
                if (currentBlock.x <= 0) {
                    currentBlock.x = 0;
                    currentBlock.direction = 1;
                } else if (currentBlock.x + currentBlock.width >= canvas.width) {
                    currentBlock.x = canvas.width - currentBlock.width;
                    currentBlock.direction = -1;
                }

                drawBlock(currentBlock, blocks.length);
            }

            requestAnimationFrame(gameLoop);
        }

        // Î∏îÎ°ù Í∑∏Î¶¨Í∏∞ (3D Ìö®Í≥º)
        function drawBlock(block, index = 0) {
            const depth = 8;
            
            // Í∑∏Î¶ºÏûê
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(block.x + 3, block.y + 3, block.width, block.height);
            
            // Ï∏°Î©¥ (3D Ìö®Í≥º)
            ctx.fillStyle = shadeColor(block.color, -30);
            ctx.beginPath();
            ctx.moveTo(block.x + block.width, block.y);
            ctx.lineTo(block.x + block.width + depth, block.y - depth);
            ctx.lineTo(block.x + block.width + depth, block.y + block.height - depth);
            ctx.lineTo(block.x + block.width, block.y + block.height);
            ctx.closePath();
            ctx.fill();
            
            // ÏÉÅÎã® (3D Ìö®Í≥º)
            ctx.fillStyle = shadeColor(block.color, 20);
            ctx.beginPath();
            ctx.moveTo(block.x, block.y);
            ctx.lineTo(block.x + depth, block.y - depth);
            ctx.lineTo(block.x + block.width + depth, block.y - depth);
            ctx.lineTo(block.x + block.width, block.y);
            ctx.closePath();
            ctx.fill();
            
            // Ï†ïÎ©¥
            ctx.fillStyle = block.color;
            ctx.fillRect(block.x, block.y, block.width, block.height);
            
            // ÌïòÏù¥ÎùºÏù¥Ìä∏
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fillRect(block.x, block.y, block.width, 5);
        }

        // ÏÉâÏÉÅ Î∞ùÍ∏∞ Ï°∞Ï†à
        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, Math.max(0, (num >> 16) + amt));
            const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
            const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        // Í≤åÏûÑ ÏãúÏûë
        function startGame() {
            menuScreen.classList.add('hidden');
            gameoverOverlay.classList.add('hidden');
            hint.style.display = 'block';
            
            totalPlays++;
            localStorage.setItem('stackPlays', totalPlays);
            totalPlaysEl.textContent = totalPlays;
            
            isPlaying = true;
            initGame();
            gameLoop();
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å
        function endGame() {
            isPlaying = false;
            
            // Í∏∞Î°ù Ï†ÄÏû•
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('stackBest', bestScore);
                bestScoreEl.textContent = bestScore;
                currentBestEl.textContent = bestScore;
                newRecordEl.classList.remove('hidden');
            } else {
                newRecordEl.classList.add('hidden');
            }
            
            // Í≤∞Í≥º ÌëúÏãú
            finalScoreEl.textContent = score;
            finalPerfectsEl.textContent = perfects;
            finalMaxComboEl.textContent = maxCombo;
            
            gameoverOverlay.classList.remove('hidden');
            hint.style.display = 'none';
        }

        // Ïù¥Î≤§Ìä∏
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', startGame);
        document.getElementById('menuBtn').addEventListener('click', () => {
            gameoverOverlay.classList.add('hidden');
            menuScreen.classList.remove('hidden');
        });

        // Î∏îÎ°ù Î∞∞Ïπò Ïù¥Î≤§Ìä∏
        canvas.addEventListener('click', placeBlock);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            placeBlock();
        }, { passive: false });

        // ÌÇ§Î≥¥Îìú
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                if (!isPlaying && !menuScreen.classList.contains('hidden')) {
                    startGame();
                } else if (!gameoverOverlay.classList.contains('hidden')) {
                    startGame();
                } else if (isPlaying) {
                    placeBlock();
                }
            }
        });

        // Ï¥àÍ∏∞ Î†åÎçîÎßÅ (Î©îÎâ¥ Î∞∞Í≤Ω)
        function renderMenuBackground() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        renderMenuBackground();
    </script>
</body>
</html>
